var province,city,sessionID=localStorage.getItem("sessionID"),Telphone=localStorage.getItem("Telphone"),openId=localStorage.getItem("openid"),indexUrL=decodeURI(window.location.href);localStorage.setItem("indexUrL",indexUrL);var gascode,employeeno,param,paramCode={codeText:"",source:source};function is_weixn(){if("micromessenger"==navigator.userAgent.toLowerCase().match(/MicroMessenger/i))if(sessionID||Telphone){$(".chanegCover").css("display","inline-block"),$(".paytext").css("display","none");var e=localStorage.getItem("indexUrL");if(unescape(e),0<(param=decodeURI(window.location.href).split("?")[1]).indexOf(":")){var o=JSON.parse(param);$(".name").html(o.n),gascode=o.s,employeeno=o.e,gasno=o.g}else param=param.match(/{(\S*)}/)[1],paramCode.codeText=param,getDataCode(getCodeText)}else $(".chanegCover").css("display","none"),$(".paytext").css("display","inline-block"),window.alert("亲请先登录哦"),window.location.href=urlHistory;else{$(".chanegCover").css("display","inline-block"),$(".paytext").css("display","none");e=localStorage.getItem("indexUrL");if(unescape(e),0<(param=decodeURI(window.location.href).split("?")[1]).indexOf(":")){o=JSON.parse(param);$(".name").html(o.n),gascode=o.s,employeeno=o.e,gasno=o.g}else param=param.match(/{(\S*)}/)[1],paramCode.codeText=param,getDataCode(getCodeText)}}function getDataCode(e){postAjax({server:e,param:{param:JSON.stringify(paramCode),version:"weixin-1.1"},fun1:function(e){"0"==e.errorcode?($(".name").html(e.code.n),gascode=e.code.s,employeeno=e.code.e):alert(e.msg)},fun2:function(e){alert(JSON.stringify(e))}})}is_weixn();var yoNumS=$(".yoNum"),yonum="",yoNumLi=$(".numLi"),yonumli="";function tiemout(){$(".Pop-ups").css("display","block");setTimeout(function(){$(".Pop-ups").css("display","none")},1500)}$(".yoNum").on("click",function(){$(".numList").css("display","none"),$(".yoMore").html("更多");$(this).index();for(var e=0;e<yoNumS.length;e++)yoNumS.removeClass("active");$(this).addClass("active"),"0#"==(yonum=$(this).html())?yonum="0":"95#"==yonum?yonum="95":"92#"==yonum?yonum="92":"98#"==yonum?yonum="98":"-10#"==yonum?yonum="-10":"-20#"==yonum?yonum="-20":"-35#"==yonum&&(yonum="-35"),$(".yoNumZF").html(yonum),$(".btnZF").attr("disabled"),$(".paymoney").val(""),$(".chanegCover").html("选择优惠券"),$(".btnZF").css("background","#f8c478"),$(".btnZF").val("支    付")});var set="";$(".paymoney").on("keydown",function(){if(""==$(".yoNumZF").html())return $(".paymoney").val(""),$(".Pop-ups").html("请选择油号"),tiemout(),!1;clearTimeout(set)}),$(".paymoney").on("keyup",function(){var e=$(".yoNumZF").html();if(""==e)return $(".paymoney").val(""),!1;var o=$(".paymoney").val();if(!/^[0-9|,|,]*\.?[0-9]{0,2}$/g.test(o))return $(".paymoney").val(""),$(".Pop-ups").html("金额格式错误"),tiemout(),clearTimeout(set),$(".chanegCover").html("选择优惠券"),$(".btnZF").css("background","#f8c478"),$(".btnZF").val("支    付"),$(".paymoney").val(""),$(".login").hide(),!1;set=setTimeout(function(){if(""==o)return o="0",$(".paymoney").val(""),$(".btnZF").attr("disabled"),$(".btnZF").css("background","#f8c478"),$(".chanegCover").html("选择优惠券"),$(".btnZF").val("支    付"),!1;parseFloat(o)<100?(paramMoney.productmoney=o,$(".couponid").html("0"),paramMoney.employeeno=employeeno,paramMoney.gasno=e,paramMoney.stationno=gascode,paramMoney.couponid="0"):(paramMoney.couponid="0",paramMoney.stationno=gascode,paramMoney.employeeno=employeeno,paramMoney.gasno=e,paramMoney.productmoney=o),getDataMoney(factMoneyPaymentPageAction)},1500)}),$(".paytext").on("click",function(){window.location.href=urlHistory});var tex=$(".paymoney").val(),off=!0;function getDatalist(e){$(".login").show(),postAjax({server:e,param:{param:JSON.stringify(paramlist),version:"weixin-1.1"},fun1:function(e){if(e.errorcode)886==e.errorcode&&(alert(e.msg),window.location.href=urlHistory);else{$(".login").hide();for(var o=e.coupons,n=parseInt(o.length),a=[],t=0;t<n;t++){var r=o[t];a.push({id:r.id,limit:r.limit,limits:r.limits,type:r.type,deadline:r.deadline,value:r.value,minpay:r.minpay})}var i=document.getElementById("demo").innerHTML;laytpl(i).render(a,function(e){document.getElementById("List").innerHTML=e}),$(".login").hide();var s=$(".coupon");$(".coupon").on("click",function(){$(this).index();for(var e=0;e<s.length;e++)s.removeClass("active");if($(this).addClass("active"),1==confirm("确认使用此优惠券吗")){var o=$(this).find(".typeid").html(),n=$(".paymoney").val(),a=$(".yoNumZF").html();paramMoney.gasno=a,paramMoney.productmoney=n,paramMoney.couponid=o,paramMoney.stationno=gascode,paramMoney.employeeno=employeeno,getDataMoney(factMoneyPaymentPageAction)}else{n=$(".paymoney").val(),a=$(".yoNumZF").html();paramMoney.gasno=a,paramMoney.productmoney=n,paramMoney.couponid="-1",paramMoney.stationno=gascode,paramMoney.employeeno=employeeno,getDataMoney(factMoneyPaymentPageAction),$(".chanegCover").html("不使用优惠券"),$(".Cover").hide()}})}},fun2:function(e){$(".login").hide()}})}$(".chanegCover").on("click",function(){if("您今天已经使用过优惠券"==$(".chanegCover").html())return alert("您今天已经使用过优惠券"),!1;var e=$(".paymoney").val(),o=$(".yoNumZF").html();return""==o?($(".Pop-ups").html("请选择油号"),tiemout(),$(".btnZF").val("支    付"),!1):""==e?(tiemout(),$(".btnZF").val("支    付"),$(".Pop-ups").html("请输入金额"),!1):(paramlist.gasno=o,paramlist.productmoney=e,paramlist.stationno=gascode,getDatalist(getCouponsListCouponsAction),void $(".Cover").show())}),paramlist={username:Telphone,channel:channel,sessionid:sessionID,pageindex:0,pagesize:100,inputflag:1,gasno:"",stationno:"",productmoney:"100",source:source},$(".close").on("click",function(){$(".Cover").hide()}),paramMoney={username:Telphone,channel:channel,sessionid:sessionID,stationno:"",employeeno:"",gasno:"",productmoney:"",couponid:"0",paytype:2,source:source};var factmoney="";function getDataMoney(e){$(".login").show(),postAjax({server:e,param:{param:JSON.stringify(paramMoney),version:"weixin-1.1"},fun1:function(e){e.errorcode?886==e.errorcode?window.location.href=urlHistory:(alert(e.msg),$(".login").hide(),$(".chanegCover").html("选择优惠券"),$(".couponid").html(),$(".Cover").show()):($(".login").hide(),$(".Cover").hide(),factmoney=e.factmoney,$(".couponid").html(e.couponsid),$(".chanegCover").html(e.couponsname),$(".btnZF").removeAttr("disabled"),$(".btnZF").css("background","#ff9900"),$(".btnZF").val("待支付"+e.factmoney+"元"))},fun2:function(e){$(".login").hide()}})}$(".btnZF").on("click",function(){$(".btnZF").removeAttr("disabled"),$(".btnZF").css("background","#f8c478");var e=$(".yoNumZF").html();paramZF.gasno=e;var o=$(".couponid").html();paramZF.couponid=o;var n=$(".paymoney").val();if(""==n)return $(".paymoney").val(""),$(".Pop-ups").html("请输入金额"),tiemout(),!1;paramZF.productmoney=n,paramZF.factmoney=factmoney,paramZF.stationno=gascode,paramZF.employeeno=employeeno,$(".btnZF").attr("disabled","disabled"),$(".btnZF").css("background","#f8c478"),getDataZF(submitPaymentPaymentPageAction)}),paramZF={username:Telphone,channel:channel,sessionid:sessionID,stationno:"",employeeno:"",gasno:"",openid:openId,couponid:"0",productmoney:"",factmoney:"",paytype:2,source:source};var orderID="",orderNUM="";function getDataZF(e){-1!=navigator.userAgent.toLowerCase().indexOf("micromessenger")?(paramZF.paytype=2,postAjax({server:e,param:{param:JSON.stringify(paramZF),version:"weixin-1.1"},fun1:function(e){if(0==e.errorcode){orderID=e.id,orderNUM=e.num;var o=e.depositid;function n(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:"wx1082c6b85beeb5dd",timeStamp:e.timeStamp,nonceStr:e.nonceStr,package:"prepay_id="+e.prepayId,signType:"MD5",paySign:e.sign},function(e){"get_brand_wcpay_request:ok"==e.err_msg?window.location.href="payResults.html?orderID="+orderID+"&orderNUM="+orderNUM:"get_brand_wcpay_request:cancel"==e.err_msg?($("#payMoney").val(""),$(".btnZF").val("待支付0元"),$(".btnZF").css("background-color","#f8c478")):"get_brand_wcpay_request:fail"==e.err_msg&&(alert("支付失败,请重新支付"),$("#payMoney").val(""),$(".btnZF").css("background-color","#f8c478"),$(".btnZF").val("待支付0元"))})}localStorage.setItem("depositID",o),localStorage.setItem("orderID",orderID),localStorage.setItem("orderNUM",orderNUM),"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",n,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",n),document.attachEvent("onWeixinJSBridgeReady",n)):n()}},fun2:function(){}})):(paramZF.paytype=1,postAjax({server:e,param:{param:JSON.stringify(paramZF),version:"weixin-1.1"},fun1:function(e){if(0==e.errorcode){orderID=e.id,orderNUM=e.num,localStorage.setItem("orderID",orderID),localStorage.setItem("orderNUM",orderNUM),console.log(e);var o=$(".name").html();aliPaySubmitH5Pay(e,Telphone,sessionID,1,o)}},fun2:function(){}}))}function aliPaySubmitH5Pay(e,o,n,a,t){var r="param="+('{"username":"'+o+'","sessionid":"'+n+'","WIDout_trade_no":"'+e.num+'","WIDsubject":"'+t+'","WIDtotal_amount":"'+e.factmoney+'","body":"油帮帮加油支付","payUse":"'+a+'","quit_url":"https://dev.yobangbang.com/wxpayweb/payResults.html","return_url":"https://dev.yobangbang.com/wxpayweb/payResults.html"}')+"&version=weixinh5";$.ajax({type:"POST",url:"https://dev.yobangbang.com/ybb/aliPaySubmitH5PayServerAction",data:r,async:!0,success:function(e){e=JSON.parse(e),console.log(e),$(".alipay").append(e.form)}})}function getDataList(e){postAjax({server:e,param:{param:JSON.stringify(paramBackdrop),version:"weixin-1.2"},fun1:function(e){if(0==e.errorcode){var o=e.coupons,n=parseInt(o.length);""==n?$(".mui-backdrop").css("display","none"):$(".mui-backdrop").css("display","block");for(var a=[],t=0;t<n;t++){var r=o[t];a.push({id:r.id,limit:r.limit,limits:r.limits,type:r.type,deadline:r.deadline,value:r.value,minpay:r.minpay})}var i=document.getElementById("YHList").innerHTML;laytpl(i).render(a,function(e){document.getElementById("ListUl").innerHTML=e})}else 886==e.errorcode?window.location.href=urlHistory:alert(e.msg)},fun2:function(e){alert(JSON.stringify(e))}})}function getPosBaidu(){(new BMap.Geolocation).getCurrentPosition(function(e){city=e.address.city,province=e.address.province,paramBackdrop.province=province,paramBackdrop.city=city,getDataList(gainCouponCouponsAction)},function(e){alert("获取百度定位位置信息失败")},{provider:"baidu"})}getPosBaidu(),paramBackdrop={province:"",city:"",username:Telphone,channel:channel,source:"Weixin",sessionid:sessionID,source:source},$(".btn").on("click",function(){var e=navigator.userAgent.toLowerCase();/iphone|ipad|ipod/.test(e)?window.location.href="https://itunes.apple.com/cn/app/%E4%B8%AD%E5%9B%BD%E9%A2%86%E5%85%88%E7%9A%84%E7%A7%BB%E5%8A%A8%E4%BA%92%E8%81%94%E7%BD%91%E5%8A%A0%E6%B2%B9%E7%AB%99/id962272538?mt=8":/android/.test(e)&&(window.location.href="http://app.qq.com/#id=detail&appid=1104434805")});